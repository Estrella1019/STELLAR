# âœ… STELLAR Ollama æœ¬åœ°åŒ–é…ç½®å®Œæˆæ€»ç»“

## ğŸ¯ é…ç½®çŠ¶æ€

**æ‰€æœ‰æ ¸å¿ƒç»„ä»¶å·²æˆåŠŸé…ç½®ä¸ºä½¿ç”¨æœ¬åœ° Ollama æ¨¡å‹ï¼**

### âœ… å·²å®Œæˆçš„ä¿®æ”¹

1. **ç¯å¢ƒå˜é‡é…ç½®** (`.env`)
   - Ollama åŸºç¡€ URL: `http://localhost:11434/v1`
   - Judge æ¨¡å‹: `deepseek-r1:7b` âœ…
   - Generator æ¨¡å‹: `dolphin3:latest` âœ…
   - SUT è¢«æµ‹æ¨¡å‹: `deepseek-r1:7b` âœ…

2. **æ¨¡å‹æšä¸¾æ³¨å†Œ** (`llm/llms.py`)
   - âœ… æ·»åŠ  `LLMType.DEEPSEEK_R1 = "deepseek-r1:7b"`
   - âœ… æ·»åŠ  `LLMType.DOLPHIN3 = "dolphin3"`
   - âœ… æ‰€æœ‰æ–°æ¨¡å‹åŠ å…¥ `LOCAL_MODELS` é›†åˆ

3. **Judge è¯„ä¼°å¢å¼º** (`examples/safety/eval.py`)
   - âœ… DeepSeek `<think>` æ ‡ç­¾æ¸…æ´—
   - âœ… Markdown ä»£ç å—æ¸…æ´—
   - âœ… å¤šæ ¼å¼è¯„åˆ†è§£æ (0-1 æµ®ç‚¹æ•°ã€1-10 æ•´æ•°)
   - âœ… å…œåº•æœºåˆ¶é˜²æ­¢è¯¯åˆ¤

4. **è¿è¡Œè„šæœ¬** (`run_safety_local.sh`)
   - âœ… é…ç½®ä¸ºå®Œå…¨æœ¬åœ°è¿è¡Œ
   - âœ… 2å°æ—¶è¶…æ—¶è®¾ç½®
   - âœ… 20ä¸ªç§ç¾¤å¤§å°
   - âœ… å¯ç”¨ä¿®å¤ç®—å­

---

## ğŸš€ è¿è¡Œå®éªŒ

### å¼€å§‹ Safety æµ‹è¯• (SafeQA)
```bash
cd /Users/panjiaying/Documents/Projects/STELLAR
chmod +x run_safety_local.sh
./run_safety_local.sh
```

### é¢„æœŸè¾“å‡º
- æµ‹è¯•ä¼šè¿è¡Œ 2 å°æ—¶æˆ– 10 ä»£
- ç»“æœä¿å­˜åœ¨ `results/` ç›®å½•
- å…³é”®æ–‡ä»¶:
  - `failures_over_time.csv` - å¤±è´¥ç‡æ—¶é—´æ›²çº¿
  - `archive.csv` - æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹
  - `critical_cases.csv` - æ”»å‡»æˆåŠŸçš„ç”¨ä¾‹

---

## ğŸ“Š å·²éªŒè¯çš„é…ç½®

### Ollama æ¨¡å‹åˆ—è¡¨ (å…±7ä¸ª)
- âœ… `deepseek-r1:7b` (SUT + Judge + Fitness)
- âœ… `dolphin3:latest` (Generator)
- âœ… `qwen2.5:7b` (å¤‡ç”¨)
- âœ… `dolphin-llama3:latest` (å¤‡ç”¨)
- âœ… `mistral:latest` (å¤‡ç”¨)
- âœ… `gemma3:1b` (å¤‡ç”¨)
- âœ… `llama3.2:latest` (å¤‡ç”¨)

### é…ç½®æµ‹è¯•ç»“æœ
```
âœ… é€šè¿‡: ç¯å¢ƒå˜é‡
âœ… é€šè¿‡: Ollama è¿æ¥
âœ… é€šè¿‡: æ¨¡å‹æ³¨å†Œ
âœ… é€šè¿‡: æ¨¡å‹è°ƒç”¨
âœ… é€šè¿‡: Judge æ¸…æ´—
```

---

## ğŸ”§ è§’è‰²åˆ†é…

æ ¹æ®è®ºæ–‡ STELLAR (è¡¨ I) çš„é…ç½®è¦æ±‚ï¼š

| ç»„ä»¶ | è®ºæ–‡åŸé…ç½® | æœ¬åœ° Ollama é…ç½® | è¯´æ˜ |
|------|-----------|----------------|------|
| **Generator** | GPT-4O-MINI | `dolphin3:latest` | ç”Ÿæˆæ”»å‡»æµ‹è¯•ç”¨ä¾‹ |
| **SUT (è¢«æµ‹ç³»ç»Ÿ)** | å¤šä¸ªæ¨¡å‹ | `deepseek-r1:7b` | è¢«æµ‹è¯•çš„ LLM |
| **Judge (è£åˆ¤)** | GPT-4O-MINI | `deepseek-r1:7b` | äºŒå…ƒåˆ¤å®šæ”»å‡»æˆåŠŸ/å¤±è´¥ |
| **Fitness (é€‚åº”åº¦)** | GPT-4O-MINI | `deepseek-r1:7b` | è¿ç»­è¯„åˆ† (0-1) |

---

## âš™ï¸ æ ¸å¿ƒæŠ€æœ¯æ ˆ

### STELLAR æ¡†æ¶æ¶æ„
```
STELLAR/
â”œâ”€â”€ llm/
â”‚   â”œâ”€â”€ llms.py              # âœ… æ¨¡å‹æšä¸¾å’Œè°ƒåº¦
â”‚   â”œâ”€â”€ call_ollama.py       # âœ… Ollama API è°ƒç”¨
â”‚   â””â”€â”€ config.py            # ç¯å¢ƒå˜é‡è¯»å–
â”œâ”€â”€ examples/safety/
â”‚   â””â”€â”€ eval.py              # âœ… Judge è¯„ä¼° + æ¸…æ´—
â”œâ”€â”€ opensbt/                 # é—ä¼ ç®—æ³•æ¡†æ¶ (NSGA-II)
â”œâ”€â”€ run_tests_safety.py      # âœ… ä¸»è¿è¡Œè„šæœ¬
â””â”€â”€ run_safety_local.sh      # âœ… æœ¬åœ°å¯åŠ¨è„šæœ¬
```

### æœç´¢ç®—æ³•é…ç½®
- **ç®—æ³•**: NSGA-II (å¤šç›®æ ‡é—ä¼ ç®—æ³•)
- **ç§ç¾¤å¤§å°**: 20
- **ä»£æ•°**: 10
- **å˜å¼‚/äº¤å‰**: ç¦»æ•£å‹æ“ä½œ (é’ˆå¯¹æ–‡æœ¬ç‰¹å¾)
- **å»é‡**: åŸºäº embedding ä½™å¼¦ç›¸ä¼¼åº¦ (é˜ˆå€¼ 0.8)

---

## ğŸ“ˆ å®éªŒç›‘æ§

### å®æ—¶æŸ¥çœ‹è¿›åº¦
```bash
# ç›‘æ§æ—¥å¿—
tail -f log.txt

# æŸ¥çœ‹ç»“æœç›®å½•
watch -n 5 'ls -lh results/'

# æ£€æŸ¥å¤±è´¥ç‡
tail -f results/*/failures_over_time.csv
```

### WandB å¯è§†åŒ– (å¯é€‰)
å¦‚æœå¯ç”¨äº† wandb (é»˜è®¤å¯ç”¨):
- é¡¹ç›®å: `stellar-reproduction`
- æŸ¥çœ‹: https://wandb.ai/your-username/stellar-reproduction

å¦‚æœä¸æƒ³ç”¨ wandb:
```bash
# æ·»åŠ  --no_wandb å‚æ•°
./run_safety_local.sh --no_wandb
```

---

## âš ï¸ æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: DeepSeek-R1 å“åº”ä¸ºç©ºæˆ–åªæœ‰æ¢è¡Œç¬¦
**åŸå› **: R1 æ¨¡å‹åœ¨æŸäº›æç¤ºè¯ä¸‹ä¼šé™·å…¥é•¿ç¯‡æ€è€ƒ
**è§£å†³**:
```bash
# æ–¹æ¡ˆ 1: ä½¿ç”¨ qwen2.5 æ›¿ä»£ (æ›´å¿«ä½†æ¨ç†èƒ½åŠ›ç¨å¼±)
# ä¿®æ”¹ .env
LLM_TYPE=qwen2.5:7b
JUDGE_MODEL=qwen2.5:7b

# æ–¹æ¡ˆ 2: å¢åŠ  max_tokens (llm/config.py)
MAX_TOKENS = 800
```

### é—®é¢˜ 2: "Could not parse safety score" è­¦å‘Šé¢‘ç¹
**åŸå› **: Judge æ¨¡å‹è¾“å‡ºæ ¼å¼ä¸ç¬¦åˆé¢„æœŸ
**è°ƒè¯•**:
```python
# åœ¨ examples/safety/eval.py çš„ eval() å‡½æ•°ä¸­æ·»åŠ :
print(f"[DEBUG] Raw response: {response}")
print(f"[DEBUG] Cleaned: {clean_response}")
```

### é—®é¢˜ 3: Ollama å†…å­˜ä¸è¶³ (OOM)
**è§£å†³**:
```bash
# æ–¹æ³• 1: ä½¿ç”¨æ›´å°çš„æ¨¡å‹
ollama pull gemma3:1b
# ä¿®æ”¹ .env: LLM_TYPE=gemma3:1b

# æ–¹æ³• 2: é™åˆ¶å¹¶å‘
# ä¿®æ”¹ llm/config.py: N_VALIDATORS = 1

# æ–¹æ³• 3: å¢åŠ ç³»ç»Ÿ swap
# macOS: ç³»ç»Ÿåå¥½è®¾ç½® -> é€šç”¨ -> å†…å­˜
```

### é—®é¢˜ 4: ç”Ÿæˆé€Ÿåº¦å¤ªæ…¢
**è§£å†³**:
```bash
# å‡å°‘ç§ç¾¤å¤§å°
./run_safety_local.sh --population_size 10

# å‡å°‘è¿è¡Œæ—¶é—´
./run_safety_local.sh --max_time "01:00:00"

# ä½¿ç”¨æ›´å¿«çš„ generator
# .env: GENERATOR_MODEL=llama3.2:latest
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

### è®ºæ–‡å…³é”®å‚æ•° (è¡¨ I)
| å‚æ•° | SafeQA | NaviQA-I/II |
|------|--------|-------------|
| ç§ç¾¤å¤§å° | 20 | 20 |
| æœç´¢æ—¶é—´ | 2h | 3h |
| Crossover é˜ˆå€¼ | 0.7 | 0.7 |
| Mutation é˜ˆå€¼ | 0.12 | 0.07 |
| ç‰¹å¾æ•°é‡ | 8 | 13 |
| Fitness æ•°é‡ | 1 | 2 |

### å‘½ä»¤å‚è€ƒ
```bash
# å®Œæ•´å‚æ•°åˆ—è¡¨
python run_tests_safety.py --help

# å¿«é€Ÿæµ‹è¯• (10åˆ†é’Ÿ)
python run_tests_safety.py \
    --sut "deepseek-r1:7b" \
    --generator "dolphin3" \
    --max_time "00:10:00" \
    --population_size 10 \
    --algorithm "rs"  # éšæœºæœç´¢æ›´å¿«

# å®Œæ•´å¤ç° (2å°æ—¶)
./run_safety_local.sh
```

---

## ğŸ“ ä¸‹ä¸€æ­¥

1. âœ… **è¿è¡Œ Safety æµ‹è¯•**
   ```bash
   ./run_safety_local.sh
   ```

2. **åˆ†æç»“æœ**
   ```bash
   # æŸ¥çœ‹å¤±è´¥ç‡
   cat results/*/failures_over_time.csv

   # æŸ¥çœ‹æ”»å‡»æˆåŠŸçš„ç”¨ä¾‹
   cat results/*/critical_cases.csv
   ```

3. **è¿è¡Œ Navigation æµ‹è¯•** (NaviQA)
   - éœ€è¦å…ˆé…ç½® `run_tests_navi.py` (ç±»ä¼¼ safety)
   - å‡†å¤‡ Yelp æ•°æ®é›†æˆ–ä½¿ç”¨ BMW çš„åŠ¨æ€ API

4. **å¯¹æ¯”è®ºæ–‡ç»“æœ** (å›¾2ã€å›¾3)
   - è®ºæ–‡ä¸­ STELLAR åœ¨ SafeQA ä¸Šæ¯” ASTRAL å¤šå‘ç° 2.2Ã— å¤±è´¥
   - æ£€æŸ¥ä½ çš„ç»“æœæ˜¯å¦ä¹Ÿæœ‰ç±»ä¼¼æå‡

---

## âœ… æ£€æŸ¥æ¸…å•

- [x] Ollama æœåŠ¡è¿è¡Œ
- [x] æ‰€éœ€æ¨¡å‹å·²ä¸‹è½½
- [x] ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®
- [x] æ¨¡å‹æšä¸¾æ³¨å†Œå®Œæˆ
- [x] Judge è¯„ä¼°æ¸…æ´—å‡½æ•°å·¥ä½œæ­£å¸¸
- [x] æ‰€æœ‰é…ç½®æµ‹è¯•é€šè¿‡
- [ ] è¿è¡Œ ./run_safety_local.sh
- [ ] ç­‰å¾…ç»“æœ (çº¦2å°æ—¶)
- [ ] åˆ†æè¾“å‡ºç»“æœ

---

## ğŸ“ è·å–å¸®åŠ©

å¦‚æœé‡åˆ°é—®é¢˜:
1. æ£€æŸ¥ `log.txt` è¯¦ç»†é”™è¯¯æ—¥å¿—
2. è¿è¡Œ `python test_ollama_setup.py` è¯Šæ–­
3. æŸ¥çœ‹ `OLLAMA_SETUP_README.md` å¸¸è§é—®é¢˜

ç¥å®éªŒé¡ºåˆ©ï¼ğŸš€
