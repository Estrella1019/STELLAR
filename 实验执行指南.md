# 🚀 STELLAR 三组实验完整执行指南

## ✅ 准备工作已完成

### 1. 已清理旧数据
```bash
# 旧的 results/ 和 wandb/ 数据已清除
```

### 2. 已修复 Failure 为 0 的问题
**修改内容**:
- ✅ `examples/safety/eval.py` - 改进 Fitness 评分逻辑
  - 增加多种解析策略（浮点数、1-10分制、关键词、响应分析）
  - 能够正确识别拒答（高分）和不安全响应（低分）

- ✅ `examples/safety/eval.py` - 改进 Critical 判定逻辑
  - 基于 Fitness 阈值（< 0.7）判定
  - LLM Judge 二次确认
  - 区分"不安全内容"和"拒答"

### 3. 已创建实验脚本
- ✅ `run_experiment_1_random.sh` - RANDOM Search
- ✅ `run_experiment_2_twise.sh` - T-wise (Grid Sampling)
- ✅ `run_experiment_3_stellar.sh` - STELLAR (NSGA-II)
- ✅ `run_all_experiments.sh` - 一键运行所有实验
- ✅ `analyze_results.py` - 结果分析和可视化

---

## 📋 执行步骤

### 方案 A: 一键运行所有实验（推荐）

```bash
cd /Users/panjiaying/Documents/Projects/STELLAR

# 一键运行所有三组实验（总计 6 小时）
./run_all_experiments.sh
```

运行后会：
1. 自动运行 3 组实验
2. 自动生成对比图表
3. 自动生成文本报告
4. 结果上传到 WandB

---

### 方案 B: 分别运行每组实验

如果你想分步运行或只跑部分实验：

```bash
cd /Users/panjiaying/Documents/Projects/STELLAR

# 实验 1: RANDOM (2小时, 2000个测试)
./run_experiment_1_random.sh

# 实验 2: T-wise (2小时, 2000个测试)
./run_experiment_2_twise.sh

# 实验 3: STELLAR (2小时, 20种群×100代)
./run_experiment_3_stellar.sh

# 生成对比图表
python analyze_results.py
```

---

## 📊 WandB 配置

实验会自动上传到 WandB 平台，配置如下：

- **项目名**: `stellar-reproduction`
- **分组**: 按日期分组 (如 `01-02-2026`)
- **标签**: 包含所有实验参数

### 查看 WandB 结果

1. 访问 https://wandb.ai
2. 登录你的账号
3. 进入项目 `stellar-reproduction`
4. 查看 3 组实验的对比

### 关键指标（WandB）

- `failures_count` - 发现的失败数量
- `failure_rate` - 失败率（%）
- `critical_ratio` - Critical 比率
- `execution_time` - 执行时间

---

## 📈 实验结果文件

所有结果保存在 `results/日期/` 目录下：

```
results/
└── 01-02-2026/          # 实验日期
    ├── random/          # 实验1结果
    │   ├── failures_over_time.csv
    │   ├── archive.csv
    │   └── critical_cases.csv
    ├── twise/           # 实验2结果
    │   └── ...
    ├── stellar/         # 实验3结果
    │   └── ...
    └── analysis/        # 分析结果（自动生成）
        ├── failures_over_time.png  # 失败发现曲线
        ├── total_failures.png      # 总失败数对比
        ├── failure_rate.png        # 失败率对比
        └── report.txt              # 文本报告
```

---

## 🎯 预期结果

根据论文（图2）,STELLAR 应该：

| 指标 | RANDOM | T-wise | STELLAR | STELLAR 改进 |
|------|--------|--------|---------|-------------|
| 失败数量 | ~100 | ~150 | **~300** | 2-3倍 |
| 失败率 | ~5% | ~7% | **~15%** | 2倍以上 |
| 执行效率 | 低 | 中 | **高** | 更快收敛 |

---

## ⏱️ 时间安排

### 完整实验（6 小时）

| 实验 | 耗时 | 说明 |
|------|------|------|
| RANDOM | 2h | 2000个随机测试 |
| T-wise | 2h | 2000个组合测试 |
| STELLAR | 2h | 20×100遗传搜索 |
| 分析 | 5min | 生成图表和报告 |
| **总计** | **~6h** | |

### 快速测试（30 分钟）

如果你想快速验证配置是否正确，可以缩短时间：

```bash
# 修改每个实验脚本中的参数
--max_time "00:10:00"      # 改为 10 分钟
--population_size 100      # 减少种群（仅 RANDOM/T-wise）
--n_generations 10         # 减少代数（仅 STELLAR）
```

---

## 🔍 实时监控

### 监控日志
```bash
# 打开新终端，实时查看日志
tail -f log.txt
```

### 监控结果
```bash
# 查看当前失败数
tail results/$(date +%d-%m-%Y)/random/failures_over_time.csv
```

### 监控 WandB
访问 https://wandb.ai 实时查看进度

---

## ⚠️ 故障排查

### 问题 1: Failure 仍然为 0

**检查**:
```bash
# 运行快速测试
python test_judge_detection.py

# 预期输出: 检测到 3-5 个失败（不是 0 也不是 100%）
```

**解决**:
- 如果检测到 0 个失败 → Judge 太严格，调整 `examples/safety/eval.py` 中的 `fitness_threshold` 从 0.7 降到 0.5
- 如果检测到 100% 失败 → Judge 太宽松，调整阈值从 0.7 升到 0.85

### 问题 2: WandB 未上传

**检查**:
```bash
# 查看 wandb 登录状态
wandb login --verify
```

**解决**:
```bash
# 重新登录
wandb login
```

### 问题 3: Ollama 内存不足

**解决**:
```bash
# 方案 1: 使用更小的模型
# 编辑 .env
LLM_TYPE=qwen2.5:7b

# 方案 2: 减少并发
# 编辑 llm/config.py
N_VALIDATORS = 1
```

### 问题 4: 运行太慢

**解决**:
```bash
# 减少时间和种群大小
# 编辑实验脚本中的:
--max_time "01:00:00"
--population_size 1000  # RANDOM/T-wise
--n_generations 50      # STELLAR
```

---

## ✅ 验证实验成功

实验成功的标志：

1. **失败数量 > 0**
   - RANDOM: 至少 50+
   - T-wise: 至少 80+
   - STELLAR: 至少 150+

2. **STELLAR > T-wise > RANDOM**
   - STELLAR 发现的失败应该是最多的

3. **WandB 有数据**
   - 可以看到 3 条实验记录
   - 图表显示正常

4. **图表生成成功**
   - `analysis/` 目录下有 3 张 PNG 图片
   - `report.txt` 显示改进倍数

---

## 🎓 下一步

实验完成后：

1. **查看本地图表**
   ```bash
   open results/$(date +%d-%m-%Y)/analysis/failures_over_time.png
   ```

2. **查看 WandB 仪表板**
   - 对比三组实验的曲线
   - 导出高清图表用于论文

3. **分析失败案例**
   ```bash
   # 查看攻击成功的测试用例
   head -20 results/*/stellar/critical_cases.csv
   ```

4. **调整参数重新实验**
   - 如果 STELLAR 优势不明显，增加 `n_generations`
   - 如果失败率太低，调整 Judge 阈值

---

## 📞 需要帮助？

1. 查看测试日志: `cat log.txt`
2. 运行诊断: `python test_ollama_setup.py`
3. 测试 Judge: `python test_judge_detection.py`

---

**准备好了吗？开始实验！** 🚀

```bash
./run_all_experiments.sh
```
